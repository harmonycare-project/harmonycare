<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ëŠ˜ì˜ ì¼ê³¼</title>
    <link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(to bottom, #e3f2fd, #f1f8e9);
            font-family: 'Dongle', sans-serif;
            text-align: center;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        h1 {
            color: #1e88e5;
            margin-bottom: 30px;
            font-size: 50px;
        }
        /* --- ê¸°ì¡´ ì¼ì • ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ --- */
        #schedule-list {
            max-width: 600px;
            margin: 0 auto 30px;
            padding: 0;
            list-style-type: none;
        }
        .schedule-item {
            background-color: #fff;
            border: 2px solid #bbdefb;
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 35px;
            transition: background-color 0.3s;
        }
        .schedule-item.completed {
            background-color: #e0e0e0;
            text-decoration: line-through;
            color: #9e9e9e;
        }
        .schedule-item .time {
            font-weight: bold;
            color: #0d47a1;
            margin-right: 15px;
        }
        .schedule-item .activity {
            flex-grow: 1;
            text-align: left;
        }
        .schedule-item button {
            font-family: 'Dongle', sans-serif;
            font-size: 28px;
            border: none;
            border-radius: 10px;
            padding: 5px 12px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.2s;
        }
        .done-btn {
            background-color: #a5d6a7;
        }
        .delete-btn {
            background-color: #ef9a9a;
        }
        /* --- ì¶”ê°€ í¼ ë° ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ì€ ìœ ì§€ --- */
        .add-form {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 15px;
            max-width: 600px;
            margin: 0 auto 30px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .add-form input {
            font-family: 'Dongle', sans-serif;
            font-size: 30px;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .add-form input[type="time"] {
            width: 120px;
        }
        .add-form input[type="text"] {
            flex-grow: 1;
        }
        #add-btn {
            font-family: 'Dongle', sans-serif;
            font-size: 30px;
            background-color: #81d4fa;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        .nav-buttons button {
            font-family: 'Dongle', sans-serif;
            font-size: 30px;
            background-color: #ffd54f;
            border: none;
            border-radius: 10px;
            padding: 10px 25px;
            margin: 0 10px;
            cursor: pointer;
        }

        /* â­ï¸ í•­ìƒ í‘œì‹œë˜ëŠ” ì¼ì • ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ (ìƒˆë¡œ ì¶”ê°€) */
        #schedule-overlay {
            position: fixed;
            top: 0;
            right: 0; /* ì˜¤ë¥¸ìª½ ìƒë‹¨ì— ë°°ì¹˜ */
            width: 250px;
            height: auto;
            max-height: 90vh;
            background-color: rgba(255, 255, 255, 0.7); /* ë°˜íˆ¬ëª… í°ìƒ‰ */
            backdrop-filter: blur(3px); /* ë°°ê²½ íë¦¼ íš¨ê³¼ */
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            padding: 10px;
            box-shadow: -4px 0 10px rgba(0, 0, 0, 0.05);
            z-index: 1000;
            overflow-y: auto;
            text-align: left;
            font-size: 20px;
            transition: transform 0.3s ease-out; /* ë¶€ë“œëŸ¬ìš´ ìˆ¨ê¹€/í‘œì‹œ ì• ë‹ˆë©”ì´ì…˜ */
            transform: translateX(100%); /* ê¸°ë³¸ì ìœ¼ë¡œ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ìˆ¨ê¹€ */
        }
        #schedule-overlay.visible {
            transform: translateX(0); /* ì„¤ì •ì´ ì¼œì§€ë©´ í‘œì‹œ */
        }

        #schedule-overlay h3 {
            font-size: 30px;
            color: #1e88e5;
            margin: 0 0 10px 0;
            font-weight: bold;
        }
        #overlay-list {
            list-style-type: none;
            padding: 0;
        }
        #overlay-list li {
            font-size: 22px;
            margin-bottom: 5px;
            color: #444;
            line-height: 1.2;
        }
        #overlay-list li .time {
            font-weight: bold;
            color: #0d47a1;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <h1>ì˜¤ëŠ˜ì˜ ì¼ê³¼</h1>

    <ul id="schedule-list"></ul>

    <div class="add-form">
        <input type="time" id="time-input">
        <input type="text" id="activity-input" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
        <button id="add-btn">ì¶”ê°€</button>
    </div>

    <div class="nav-buttons">
        <button onclick="goBack()">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>
        <button onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
    </div>

    <div id="schedule-overlay">
        <h3>ë¯¸ì™„ë£Œ ì¼ê³¼</h3>
        <ul id="overlay-list">
            </ul>
    </div>

    <script>
        const scheduleList = document.getElementById('schedule-list');
        const timeInput = document.getElementById('time-input');
        const activityInput = document.getElementById('activity-input');
        const addBtn = document.getElementById('add-btn');
        const alarmSound = new Audio('alarm.mp3'); 
        const scheduleOverlay = document.getElementById('schedule-overlay');
        const overlayList = document.getElementById('overlay-list');

        let schedule = JSON.parse(localStorage.getItem('schedule')) || [];

        function saveSchedule() {
            localStorage.setItem('schedule', JSON.stringify(schedule));
        }

        // â­ï¸ ì˜¤ë²„ë ˆì´ ë Œë”ë§ í•¨ìˆ˜
        function renderOverlay() {
            // 'alwaysShowSchedule' ì„¤ì •ì— ë”°ë¼ ì˜¤ë²„ë ˆì´ í‘œì‹œ ì—¬ë¶€ ê²°ì •
            const showSchedule = localStorage.getItem('alwaysShowSchedule') === 'true';

            if (showSchedule) {
                scheduleOverlay.classList.add('visible');
                
                const incompleteSchedule = schedule
                    .filter(item => !item.completed)
                    .sort((a, b) => a.time.localeCompare(b.time));

                overlayList.innerHTML = '';
                
                if (incompleteSchedule.length === 0) {
                    overlayList.innerHTML = '<li>ğŸ‰ ì™„ë£Œëœ ì¼ê³¼ë§Œ ë‚¨ì•˜ì–´ìš”!</li>';
                } else {
                    incompleteSchedule.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span class="time">${item.time}</span> ${item.activity}`;
                        overlayList.appendChild(li);
                    });
                }

            } else {
                scheduleOverlay.classList.remove('visible');
            }
        }
        // -----------------------------

        function renderSchedule() {
            scheduleList.innerHTML = '';
            schedule.sort((a, b) => a.time.localeCompare(b.time));

            schedule.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = `schedule-item ${item.completed ? 'completed' : ''}`;
                li.innerHTML = `
                    <span class="time">${item.time}</span>
                    <span class="activity">${item.activity}</span>
                    <button class="done-btn" onclick="toggleComplete(${index})">ì™„ë£Œ</button>
                    <button class="delete-btn" onclick="deleteItem(${index})">ì‚­ì œ</button>
                `;
                scheduleList.appendChild(li);
            });
            
            // â­ï¸ ì˜¤ë²„ë ˆì´ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
            renderOverlay(); 
        }

        function addItem() {
            if (timeInput.value && activityInput.value) {
                schedule.push({ 
                    time: timeInput.value, 
                    activity: activityInput.value, 
                    completed: false,
                    notified: false,
                    lastNagged: null
                });
                timeInput.value = '';
                activityInput.value = '';
                saveSchedule();
                renderSchedule();
            } else {
                alert('ì‹œê°„ê³¼ í•  ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        function toggleComplete(index) {
            schedule[index].completed = !schedule[index].completed;
            if (schedule[index].completed) {
                schedule[index].notified = false;
                schedule[index].lastNagged = null; 
            }
            saveSchedule();
            renderSchedule();
        }

        function deleteItem(index) {
            schedule.splice(index, 1);
            saveSchedule();
            renderSchedule();
        }

        function goBack() {
            history.back();
        }

        function goHome() {
            location.href = 'main.html';
        }

        addBtn.addEventListener('click', addItem);
        activityInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addItem();
        });

        // --- ì•ŒëŒ ê¸°ëŠ¥ì€ ê·¸ëŒ€ë¡œ ìœ ì§€ ---
        function checkAlarms() {
            const now = new Date();
            const currentHour = String(now.getHours()).padStart(2, '0');
            const currentMinute = String(now.getMinutes()).padStart(2, '0');
            const currentTime = `${currentHour}:${currentMinute}`;
            const oneMinuteAgo = now.getTime() - (1 * 60 * 1000);

            schedule.forEach((item) => {
                if (item.completed) return;

                // 1. ì •ì‹œ ì•Œë¦¼
                if (!item.notified && item.time === currentTime) {
                    alarmSound.play();
                    alert(`â° ${item.activity} í•  ì‹œê°„ì´ì—ìš”!`);
                    item.notified = true;
                    saveSchedule();
                }

                // 2. ì¬ì´‰ ì•Œë¦¼
                const lastNaggedTime = item.lastNagged ? new Date(item.lastNagged).getTime() : 0;
                if (item.time < currentTime && lastNaggedTime < oneMinuteAgo) {
                    alarmSound.play();
                    alert(`ğŸƒ ì•„ì§ '${item.activity}'ì„(ë¥¼) ì™„ë£Œí•˜ì§€ ì•Šì•˜ì–´ìš”! ì„œë‘ë¥´ì„¸ìš”!`);
                    item.lastNagged = now.toISOString();
                    saveSchedule();
                }
            });
        }

        setInterval(checkAlarms, 1000);

        // â­ï¸ DOMContentLoadedì—ì„œ ë Œë”ë§ ì‹œì‘
        document.addEventListener('DOMContentLoaded', () => {
             renderSchedule(); // ì£¼ìš” ì¼ì • ë¦¬ìŠ¤íŠ¸ ë° ì˜¤ë²„ë ˆì´ ë Œë”ë§ ì‹œì‘
        });
        
        // â­ï¸ ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì˜¤ë²„ë ˆì´ ë Œë”ë§ í•¨ìˆ˜ë¥¼ window ê°ì²´ì— ë“±ë¡í•©ë‹ˆë‹¤.
        window.renderGlobalScheduleOverlay = renderOverlay; 
    </script>
</body>
</html>
