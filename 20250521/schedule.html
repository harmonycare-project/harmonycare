<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>오늘의 일과</title>
  <link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to bottom, #e3f2fd, #f1f8e9);
      font-family: 'Dongle', sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    h1 {
      color: #1e88e5;
      margin-bottom: 30px;
      font-size: 50px;
    }
    #schedule-list {
      max-width: 600px;
      margin: 0 auto 30px;
      padding: 0;
      list-style-type: none;
    }
    .schedule-item {
      background-color: #fff;
      border: 2px solid #bbdefb;
      border-radius: 15px;
      padding: 15px 20px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 35px;
      transition: background-color 0.3s;
    }
    .schedule-item.completed {
      background-color: #e0e0e0;
      text-decoration: line-through;
      color: #9e9e9e;
    }
    .schedule-item .time {
      font-weight: bold;
      color: #0d47a1;
      margin-right: 15px;
    }
    .schedule-item .activity {
      flex-grow: 1;
      text-align: left;
    }
    .schedule-item button {
      font-family: 'Dongle', sans-serif;
      font-size: 28px;
      border: none;
      border-radius: 10px;
      padding: 5px 12px;
      cursor: pointer;
      margin-left: 10px;
      transition: background-color 0.2s;
    }
    .done-btn {
      background-color: #a5d6a7;
    }
    .done-btn:hover {
      background-color: #81c784;
    }
    .delete-btn {
      background-color: #ef9a9a;
    }
    .delete-btn:hover {
      background-color: #e57373;
    }
    .add-form {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 15px;
      max-width: 600px;
      margin: 0 auto 30px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .add-form input {
      font-family: 'Dongle', sans-serif;
      font-size: 30px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .add-form input[type="time"] {
      width: 120px;
    }
    .add-form input[type="text"] {
      flex-grow: 1;
    }
    #add-btn {
      font-family: 'Dongle', sans-serif;
      font-size: 30px;
      background-color: #81d4fa;
      border: none;
      padding: 8px 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    .nav-buttons button {
      font-family: 'Dongle', sans-serif;
      font-size: 30px;
      background-color: #ffd54f;
      border: none;
      border-radius: 10px;
      padding: 10px 25px;
      margin: 0 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>오늘의 일과</h1>

  <ul id="schedule-list"></ul>

  <div class="add-form">
    <input type="time" id="time-input">
    <input type="text" id="activity-input" placeholder="할 일을 입력하세요">
    <button id="add-btn">추가</button>
  </div>

  <div class="nav-buttons">
    <button onclick="goBack()">🔙 뒤로가기</button>
    <button onclick="goHome()">🏠 홈으로</button>
  </div>

  <script>
    const scheduleList = document.getElementById('schedule-list');
    const timeInput = document.getElementById('time-input');
    const activityInput = document.getElementById('activity-input');
    const addBtn = document.getElementById('add-btn');
    const alarmSound = new Audio('alarm.mp3'); // 알림 소리 파일

    let schedule = JSON.parse(localStorage.getItem('schedule')) || [];

    function saveSchedule() {
      localStorage.setItem('schedule', JSON.stringify(schedule));
    }

    function renderSchedule() {
      scheduleList.innerHTML = '';
      schedule.sort((a, b) => a.time.localeCompare(b.time)); // 시간순 정렬

      schedule.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = `schedule-item ${item.completed ? 'completed' : ''}`;
        li.innerHTML = `
          <span class="time">${item.time}</span>
          <span class="activity">${item.activity}</span>
          <button class="done-btn" onclick="toggleComplete(${index})">완료</button>
          <button class="delete-btn" onclick="deleteItem(${index})">삭제</button>
        `;
        scheduleList.appendChild(li);
      });
    }

    function addItem() {
      if (timeInput.value && activityInput.value) {
        schedule.push({ 
          time: timeInput.value, 
          activity: activityInput.value, 
          completed: false,
          notified: false, // 정시 알림 여부 플래그
          lastNagged: null // 마지막 재촉 알림 시간
        });
        timeInput.value = '';
        activityInput.value = '';
        saveSchedule();
        renderSchedule();
      } else {
        alert('시간과 할 일을 모두 입력해주세요.');
      }
    }

    function toggleComplete(index) {
      schedule[index].completed = !schedule[index].completed;
      // 완료 시 알림 플래그 초기화 (다음에 다시 추가될 경우를 대비)
      if (schedule[index].completed) {
        schedule[index].notified = false;
      }
      saveSchedule();
      renderSchedule();
    }

    function deleteItem(index) {
      schedule.splice(index, 1);
      saveSchedule();
      renderSchedule();
    }

    function goBack() {
      history.back();
    }

    function goHome() {
      location.href = 'main.html';
    }

    addBtn.addEventListener('click', addItem);
    activityInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addItem();
    });

    // --- 알람 기능 추가 ---
    function checkAlarms() {
      const now = new Date();
      // 현재 시간을 "HH:MM" 형식으로 맞춤
      const currentHour = String(now.getHours()).padStart(2, '0');
      const currentMinute = String(now.getMinutes()).padStart(2, '0');
      const currentTime = `${currentHour}:${currentMinute}`;

      schedule.forEach((item, index) => {
        // 1. 정시 알림: 시간이 됐고, 아직 완료 및 알림 전이면 실행
        if (!item.completed && !item.notified && item.time === currentTime) {
          alarmSound.play(); // 소리 재생
          alert(`⏰ ${item.activity} 할 시간이에요!`);
          item.notified = true; // 알림 울렸다고 표시
          saveSchedule();
        }

        // 2. 재촉 알림: 시간이 지났고, 완료되지 않았으며, 마지막 재촉 후 1분이 지났으면 실행
        const oneMinuteAgo = now.getTime() - (1 * 60 * 1000);
        const lastNaggedTime = item.lastNagged ? new Date(item.lastNagged).getTime() : 0;

        if (!item.completed && item.time < currentTime && lastNaggedTime < oneMinuteAgo) {
           alarmSound.play(); // 소리 재생
           alert(`🏃 아직 '${item.activity}'을(를) 완료하지 않았어요! 서두르세요!`);
           item.lastNagged = now.toISOString(); // 현재 시간을 마지막 재촉 시간으로 기록
           saveSchedule();
        }
      });
    }

    // 1초(1000ms)마다 알람 체크 함수 실행
    setInterval(checkAlarms, 1000);

    document.addEventListener('DOMContentLoaded', renderSchedule);
  </script>
</body>
</html>
