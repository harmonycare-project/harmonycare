<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì˜¤ëŠ˜ì˜ ì¼ê³¼</title>
  <link href="https://fonts.googleapis.com/css2?family=Dongle&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(to bottom, #e3f2fd, #f1f8e9);
      font-family: 'Dongle', sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
    }
    h1 {
      color: #1e88e5;
      margin-bottom: 30px;
      font-size: 50px;
    }
    #schedule-list {
      max-width: 600px;
      margin: 0 auto 30px;
      padding: 0;
      list-style-type: none;
    }
    .schedule-item {
      background-color: #fff;
      border: 2px solid #bbdefb;
      border-radius: 15px;
      padding: 15px 20px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 35px;
      transition: background-color 0.3s;
    }
    .schedule-item.completed {
      background-color: #e0e0e0;
      text-decoration: line-through;
      color: #9e9e9e;
    }
    .schedule-item .time {
      font-weight: bold;
      color: #0d47a1;
      margin-right: 15px;
    }
    .schedule-item .activity {
      flex-grow: 1;
      text-align: left;
    }
    .schedule-item button {
      font-family: 'Dongle', sans-serif;
      font-size: 28px;
      border: none;
      border-radius: 10px;
      padding: 5px 12px;
      cursor: pointer;
      margin-left: 10px;
      transition: background-color 0.2s;
    }
    .done-btn {
      background-color: #a5d6a7;
    }
    .done-btn:hover {
      background-color: #81c784;
    }
    .delete-btn {
      background-color: #ef9a9a;
    }
    .delete-btn:hover {
      background-color: #e57373;
    }
    .add-form {
      background-color: #ffffff;
      padding: 20px;
      border-radius: 15px;
      max-width: 600px;
      margin: 0 auto 30px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .add-form input {
      font-family: 'Dongle', sans-serif;
      font-size: 30px;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .add-form input[type="time"] {
      width: 120px;
    }
    .add-form input[type="text"] {
      flex-grow: 1;
    }
    #add-btn {
      font-family: 'Dongle', sans-serif;
      font-size: 30px;
      background-color: #81d4fa;
      border: none;
      padding: 8px 20px;
      border-radius: 8px;
      cursor: pointer;
    }
    .nav-buttons button {
      font-family: 'Dongle', sans-serif;
      font-size: 30px;
      background-color: #ffd54f;
      border: none;
      border-radius: 10px;
      padding: 10px 25px;
      margin: 0 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ì˜¤ëŠ˜ì˜ ì¼ê³¼</h1>

  <ul id="schedule-list"></ul>

  <div class="add-form">
    <input type="time" id="time-input">
    <input type="text" id="activity-input" placeholder="í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”">
    <button id="add-btn">ì¶”ê°€</button>
  </div>

  <div class="nav-buttons">
    <button onclick="goBack()">ğŸ”™ ë’¤ë¡œê°€ê¸°</button>
    <button onclick="goHome()">ğŸ  í™ˆìœ¼ë¡œ</button>
  </div>

  <script>
    const scheduleList = document.getElementById('schedule-list');
    const timeInput = document.getElementById('time-input');
    const activityInput = document.getElementById('activity-input');
    const addBtn = document.getElementById('add-btn');
    const alarmSound = new Audio('alarm.mp3'); // ì•Œë¦¼ ì†Œë¦¬ íŒŒì¼

    let schedule = JSON.parse(localStorage.getItem('schedule')) || [];

    function saveSchedule() {
      localStorage.setItem('schedule', JSON.stringify(schedule));
    }

    function renderSchedule() {
      scheduleList.innerHTML = '';
      schedule.sort((a, b) => a.time.localeCompare(b.time)); // ì‹œê°„ìˆœ ì •ë ¬

      schedule.forEach((item, index) => {
        const li = document.createElement('li');
        li.className = `schedule-item ${item.completed ? 'completed' : ''}`;
        li.innerHTML = `
          <span class="time">${item.time}</span>
          <span class="activity">${item.activity}</span>
          <button class="done-btn" onclick="toggleComplete(${index})">ì™„ë£Œ</button>
          <button class="delete-btn" onclick="deleteItem(${index})">ì‚­ì œ</button>
        `;
        scheduleList.appendChild(li);
      });
    }

    function addItem() {
      if (timeInput.value && activityInput.value) {
        schedule.push({ 
          time: timeInput.value, 
          activity: activityInput.value, 
          completed: false,
          notified: false, // ì •ì‹œ ì•Œë¦¼ ì—¬ë¶€ í”Œë˜ê·¸
          lastNagged: null // ë§ˆì§€ë§‰ ì¬ì´‰ ì•Œë¦¼ ì‹œê°„
        });
        timeInput.value = '';
        activityInput.value = '';
        saveSchedule();
        renderSchedule();
      } else {
        alert('ì‹œê°„ê³¼ í•  ì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      }
    }

    function toggleComplete(index) {
      schedule[index].completed = !schedule[index].completed;
      // ì™„ë£Œ ì‹œ ì•Œë¦¼ í”Œë˜ê·¸ ì´ˆê¸°í™” (ë‹¤ìŒì— ë‹¤ì‹œ ì¶”ê°€ë  ê²½ìš°ë¥¼ ëŒ€ë¹„)
      if (schedule[index].completed) {
        schedule[index].notified = false;
      }
      saveSchedule();
      renderSchedule();
    }

    function deleteItem(index) {
      schedule.splice(index, 1);
      saveSchedule();
      renderSchedule();
    }

    function goBack() {
      history.back();
    }

    function goHome() {
      location.href = 'main.html';
    }

    addBtn.addEventListener('click', addItem);
    activityInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') addItem();
    });

    // --- ì•ŒëŒ ê¸°ëŠ¥ ì¶”ê°€ ---
    function checkAlarms() {
      const now = new Date();
      // í˜„ì¬ ì‹œê°„ì„ "HH:MM" í˜•ì‹ìœ¼ë¡œ ë§ì¶¤
      const currentHour = String(now.getHours()).padStart(2, '0');
      const currentMinute = String(now.getMinutes()).padStart(2, '0');
      const currentTime = `${currentHour}:${currentMinute}`;

      schedule.forEach((item, index) => {
        // 1. ì •ì‹œ ì•Œë¦¼: ì‹œê°„ì´ ëê³ , ì•„ì§ ì™„ë£Œ ë° ì•Œë¦¼ ì „ì´ë©´ ì‹¤í–‰
        if (!item.completed && !item.notified && item.time === currentTime) {
          alarmSound.play(); // ì†Œë¦¬ ì¬ìƒ
          alert(`â° ${item.activity} í•  ì‹œê°„ì´ì—ìš”!`);
          item.notified = true; // ì•Œë¦¼ ìš¸ë ¸ë‹¤ê³  í‘œì‹œ
          saveSchedule();
        }

        // 2. ì¬ì´‰ ì•Œë¦¼: ì‹œê°„ì´ ì§€ë‚¬ê³ , ì™„ë£Œë˜ì§€ ì•Šì•˜ìœ¼ë©°, ë§ˆì§€ë§‰ ì¬ì´‰ í›„ 1ë¶„ì´ ì§€ë‚¬ìœ¼ë©´ ì‹¤í–‰
        const oneMinuteAgo = now.getTime() - (1 * 60 * 1000);
        const lastNaggedTime = item.lastNagged ? new Date(item.lastNagged).getTime() : 0;

        if (!item.completed && item.time < currentTime && lastNaggedTime < oneMinuteAgo) {
           alarmSound.play(); // ì†Œë¦¬ ì¬ìƒ
           alert(`ğŸƒ ì•„ì§ '${item.activity}'ì„(ë¥¼) ì™„ë£Œí•˜ì§€ ì•Šì•˜ì–´ìš”! ì„œë‘ë¥´ì„¸ìš”!`);
           item.lastNagged = now.toISOString(); // í˜„ì¬ ì‹œê°„ì„ ë§ˆì§€ë§‰ ì¬ì´‰ ì‹œê°„ìœ¼ë¡œ ê¸°ë¡
           saveSchedule();
        }
      });
    }

    // 1ì´ˆ(1000ms)ë§ˆë‹¤ ì•ŒëŒ ì²´í¬ í•¨ìˆ˜ ì‹¤í–‰
    setInterval(checkAlarms, 1000);

    document.addEventListener('DOMContentLoaded', renderSchedule);
  </script>
</body>
</html>
